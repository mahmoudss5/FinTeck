---
config:
  theme: dark
---
flowchart TD
    Start((Start)) --> ValidateInput[Validate Input Data]
    ValidateInput --> IsValid{Valid Inputs?}

    IsValid -- No --> ErrorResponse[Return 400 Bad Request]
    IsValid -- Yes --> FetchWallets[Fetch Sender & Receiver Wallets]

    FetchWallets --> WalletsExist{Wallets Exist?}
    WalletsExist -- No --> NotFound[Return 404 Not Found]
    WalletsExist -- Yes --> CheckBalance{Balance >= Amount?}

    CheckBalance -- No --> InsufficientFunds[Return 400 Insufficient Funds]
    CheckBalance -- Yes --> StartTx[Start DB Transaction]

    StartTx --> AcquireLock[Check Wallet Version<br/>Optimistic Lock]
    AcquireLock --> LockOk{Version Valid?}

    LockOk -- No --> ConflictError[Return 409 Conflict<br/>Retry Transfer]
    LockOk -- Yes --> Debit[Debit Sender Wallet]

    Debit --> Credit[Credit Receiver Wallet]
    Credit --> SaveLog[Save Transaction Record]
    SaveLog --> IncrementVersion[Increment Wallet Versions]
    IncrementVersion --> CommitTx[Commit Transaction]

    CommitTx --> Success[Return 200 OK]

    ErrorResponse --> End((End))
    NotFound --> End
    InsufficientFunds --> End
    ConflictError --> End
    Success --> End